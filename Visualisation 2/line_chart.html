<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/vega@5.20.2"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5.1.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6.17.0"></script>
  <link rel="stylesheet" type="text/css" href="css/styles.css" media="all">
  <title>Total CO₂ Emissions (2000–2023)</title>
</head>
<body>
  <div id="vis"></div>

  <script>
    const spec = {
      "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
      "title": "Total CO₂ Emissions (2000–2023)",
      "width": 800,
      "height": 400,

      "data": {
        "url": "data/global_co2_2000_2023_filtered.csv"
      },

      "transform": [
        {"calculate": "toNumber(datum.year)", "as": "year_num"},
        {"calculate": "toNumber(datum.co2)", "as": "co2_num"},
        {"filter": "isValid(datum.co2_num) && isValid(datum.year_num)"},
        {
          "calculate": "datum.country == 'China' || datum.country == 'United States' || datum.country == 'India' || datum.country == 'Russia' || datum.country == 'Japan' || datum.country =='Australia' ? datum.country : null",
          "as": "top_country"
        }
      ],

      "layer": [
        // 1️⃣ Global average line
        {
          "transform": [
            {
              "aggregate": [{"op": "mean", "field": "co2_num", "as": "avg_co2"}],
              "groupby": ["year_num"]
            },
            {"calculate": "'Global Average'", "as": "country"}
          ],
          "mark": {"type": "line", "strokeDash": [5,3], "strokeWidth": 2},
          "encoding": {
            "x": {
              "field": "year_num",
              "type": "quantitative",
              "title": "Year",
              "axis": {
                "tickCount": 6,
                "values": [2000, 2005, 2010, 2015, 2020, 2023],
                "format": "d"
              }
            },
            "y": {"field": "avg_co2", "type": "quantitative", "title": "CO₂ Emissions (Mt)"},
            "color": {
              "field": "country",
              "type": "nominal",
              "scale": {
                "domain": ["China", "United States", "India", "Russia", "Japan", "Australia","Global Average"],
                "range": ["#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#ff7f00", "#a65628","black"]
              },
              "title": "Country"
            },
            "tooltip": [
              {"field": "country", "title": "Country"},
              {"field": "avg_co2", "title": "CO₂ (Mt, avg)", "format": ".2f"},
              {"field": "year_num", "title": "Year"}
            ]
          }
        },

        // 2️⃣ Global average points
        {
          "transform": [
            {
              "aggregate": [{"op": "mean", "field": "co2_num", "as": "avg_co2"}],
              "groupby": ["year_num"]
            },
            {"calculate": "'Global Average'", "as": "country"}
          ],
          "mark": {"type": "point", "filled": true, "size": 50, "color": "black"},
          "encoding": {
            "x": {
              "field": "year_num",
              "type": "quantitative",
              "axis": {
                "tickCount": 6,
                "values": [2000, 2005, 2010, 2015, 2020, 2023],
                "format": "d"
              }
            },
            "y": {"field": "avg_co2", "type": "quantitative"},
            "tooltip": [
              {"field": "country", "title": "Country"},
              {"field": "avg_co2", "title": "CO₂ (Mt, avg)", "format": ".2f"},
              {"field": "year_num", "title": "Year"}
            ]
          }
        },

        // 3️⃣ Lines for top 5 + Australia
        {
          "transform": [{"filter": "datum.top_country != null"}],
          "mark": {"type": "line"},
          "encoding": {
            "x": {
              "field": "year_num",
              "type": "quantitative",
              "title": "Year",
              "axis": {
                "tickCount": 6,
                "values": [2000, 2005, 2010, 2015, 2020, 2023],
                "format": "d"
              }
            },
            "y": {"field": "co2_num", "type": "quantitative", "title": "CO₂ Emissions (Mt)"},
            "color": {
              "field": "country",
              "type": "nominal",
              "scale": {
                "domain": ["China", "United States", "India", "Russia", "Japan", "Australia","Global Average"],
                "range": ["#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#ff7f00", "#a65628","black"]
              },
              "title": "Country"
            },
            "tooltip": [
              {"field": "country", "title": "Country"},
              {"field": "year_num", "title": "Year"},
              {"field": "co2_num", "title": "CO₂ (Mt)"}
            ]
          }
        },

        // 4️⃣ Points for each country
        {
          "transform": [{"filter": "datum.top_country != null"}],
          "mark": {"type": "point", "filled": true, "size": 50},
          "encoding": {
            "x": {
              "field": "year_num",
              "type": "quantitative",
              "axis": {
                "tickCount": 6,
                "values": [2000, 2005, 2010, 2015, 2020, 2023],
                "format": "d"
              }
            },
            "y": {"field": "co2_num", "type": "quantitative"},
            "color": {
              "field": "country",
              "type": "nominal",
              "scale": {
                "domain": ["China", "United States", "India", "Russia", "Japan", "Australia","Global Average"],
                "range": ["#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#ff7f00", "#a65628","black"]
              },
              "legend": {"title": "Country"}
            },
            "tooltip": [
              {"field": "country", "title": "Country"},
              {"field": "year_num", "title": "Year"},
              {"field": "co2_num", "title": "CO₂ (Mt)"}
            ]
          }
        }
      ]
    };

    vegaEmbed("#vis", spec, {mode: "vega-lite"}).then(console.log).catch(console.warn);
  </script>
</body>
</html>
